<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Docker Dashboard</title>
  <script src="https://unpkg.com/htmx.org@1.9.9"></script>
 <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      display: flex;
      justify-content: center; 
    }

    .dashboard-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 2rem;              
      max-width: 1200px;
      margin: 0 auto;
    }

    .section {
        flex: 1;
        min-width: 400px;
        max-width: 600px;
        text-align: center;
    }

    .section h2 {
      margin-bottom: 1rem;
    }

    .container-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 1rem 0;
    }

    .refresh-button {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
    }

    .refresh-button:hover {
      background-color: #f0f0f0;
    }

    .input-row {
      margin-bottom: 1rem;
    }

    .horizontal-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .vl {
      border-left: 3px solid green;
      height: 600px;
    }

    #image-list, #container-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .pill {
      background: #eee;
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      display: flex;
      align-items: center;
    }

    .pill button {
      margin-left: 0.5rem;
      background: none;
      border: none;
      color: red;
      cursor: pointer;
    }
    
    #image-list table,
    #container-list table {
      width: 100%;
      border-collapse: collapse;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }

    table, th, td {
      border: 1px solid #ccc;
    }

    th, td {
      padding: 0.5rem;
      text-align: center;
    }

    tr:hover {
      background-color: #f1f1f1;
      cursor: pointer;
    }

    .disabled {
      color: #aaa;
      pointer-events: none;
    }

    dialog {
      text-align: center;
      border: none;
      padding: 2rem;
      border-radius: 10px;
      width: 500px;
    }

    dialog::backdrop {
      background: rgba(0, 0, 0, 0.5);
    }
  </style>
</head>
<body>

<div class="dashboard-container">
  <!-- IMAGES SECTION -->
  <div class="section" id="image-section">
    <h2>Docker Images</h2>

    <div class="input-row">
      <input type="text" id="image-input" name="image_name" placeholder="e.g. user/image" />
      <button 
        hx-post="/images"
        hx-trigger="click"
        hx-target="#image-list"
        hx-swap="outerHTML"
        hx-include="#image-input"
      >
        Add
      </button>
    </div>

    <div id="image-list" hx-get="/images" hx-trigger="load" hx-swap="outerHTML"></div>
  </div>

  <div class="vl"></div>

  <!-- CONTAINERS SECTION -->
  <div class="section" id="container-section">
    <h2>Containers</h2>
    <button onclick="openDialog()">Run a Container</button>

    <div class="container-controls">
      <label>
        <input type="checkbox" id="show-all-checkbox" name="all"> All
      </label>
      <button 
        hx-get="/containers"
        hx-trigger="click"
        hx-target="#container-list"
        hx-swap="outerHTML"
        hx-include="#show-all-checkbox">⟳</button>
    </div>

    <div id="container-list" hx-get="/containers" hx-trigger="load,fetch-containers from:body" hx-swap="outerHTML">
</div>
  </div>
</div>

<!-- CONTAINER DIALOG -->
<dialog id="container-dialog">
  <form method="dialog" onsubmit="submitContainer(event)">
    <h3>Create Container</h3>

    <label>Image:</label><br>
    <input type="text" id="container-image" oninput="updateSuggestions()" list="image-suggestions" required><br>
    <datalist id="image-suggestions"></datalist><br>

    <label>Container Name:</label><br>
    <input type="text" id="container-name" required>
    <datalist id="container-name"></datalist><br><br>

    <label>Expose Port(s):</label><br>
    <input type="text" id="port-input" placeholder="e.g. 8080:80" />
    <button type="button" onclick="addPort()">Expose Port</button>
    <div class="horizontal-list" id="port-list"></div><br>

    <label>Command:</label><br>
    <textarea id="command-input" rows="4" style="width: 100%;"></textarea><br><br>

    <button type="submit">Run</button>
    <button type="button" onclick="closeDialog()">Cancel</button>
  </form>
</dialog>

<script>
  const portList = [];

  function openDialog() {
    document.getElementById('container-dialog').showModal();
    updateSuggestions();
  }

  function closeDialog() {
    document.getElementById('container-dialog').close();
  }

  function addPort() {
    const portInput = document.getElementById('port-input');
    const value = portInput.value.trim();
    if (value && !portList.includes(value)) {
      portList.push(value);
      portInput.value = '';
      renderPortList();
    }
  }

  function removePort(port) {
    const idx = portList.indexOf(port);
    if (idx !== -1) {
      portList.splice(idx, 1);
      renderPortList();
    }
  }

  function renderPortList() {
    const list = document.getElementById('port-list');
    list.innerHTML = '';
    portList.forEach(port => {
      const pill = document.createElement('div');
      pill.className = 'pill';
      pill.textContent = port;
      const closeBtn = document.createElement('button');
      closeBtn.textContent = '×';
      closeBtn.onclick = () => removePort(port);
      pill.appendChild(closeBtn);
      list.appendChild(pill);
    });
  }

  function updateSuggestions() {
    const input = document.getElementById('container-image').value.toLowerCase();
    fetch('/images')
      .then(res => res.text())
      .then(html => {
        const temp = document.createElement('div');
        temp.innerHTML = html;
        const rows = temp.querySelectorAll('[data-image-name]');
        const datalist = document.getElementById('image-suggestions');
        datalist.innerHTML = '';
        rows.forEach(row => {
          const name = row.getAttribute('data-image-name');
          if (name.toLowerCase().includes(input)) {
            const opt = document.createElement('option');
            opt.value = name;
            datalist.appendChild(opt);
          }
        });
      });
  }

  function submitContainer(event) {
    event.preventDefault();
    const container_name = document.getElementById('container-name').value;
    const image = document.getElementById('container-image').value;
    const commands = document.getElementById('command-input').value.split("\n");
    const ports = {};

    portList.forEach(p => {
      const [host, container] = p.split(':');
      if (host && container) {
        ports[container] = host;
      }
    });

    fetch('/containers', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: container_name, image_name: image, commands: commands, ports })
    }).then(res => {
      if (res.ok) {
        closeDialog();
        fetchContainers();
      }
    });
  }

//   function fetchContainers() {
//     let url = '/containers';
//     const all = document.getElementById('show-all-checkbox').checked;
//     if (all) {
//       url += '?all=true';
//     }

//     const el = document.getElementById('container-list');
//     el.setAttribute('hx-get', url);
//     htmx.trigger(el, 'refresh');
//   }
  

  document.body.addEventListener('click', function (e) {
    const row = e.target.closest('[data-image-name]');
    if (row) {
      const imageName = row.getAttribute('data-image-name');
      fetchContainers(imageName);
    }
  });

  document.body.addEventListener('htmx:afterSwap', function (evt) {
    if (evt.target.id === 'container-list') {
      evt.target.removeAttribute('hx-get');
    }
  });
</script>

</body>
</html>